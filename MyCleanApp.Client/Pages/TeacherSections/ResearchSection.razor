@inject MyCleanApp.Client.Services.ResearchProjectService ResearchProjectService
@inject MyCleanApp.Client.Services.TeacherService TeacherService
@inject LocalStorageService LocalStorageService

@* Sección Investigación *@
<div class="space-y-4">
    @if (isLoading)
    {
        <div class="p-6">Cargando proyectos de investigación...</div>
    }
    else if (!string.IsNullOrEmpty(error))
    {
        <div class="p-6 text-red-600">Error: @error</div>
    }
    else
    {
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
            <div class="p-6">
                <div class="flex flex-row items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-medium">Proyectos de Investigación</h3>
                        <p class="text-sm text-gray-600">Total proyectos: @(proyectos?.Count ?? 0)</p>
                    </div>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors" @onclick="()=>MostrarFormularioNuevo()">Registrar Proyecto</button>
                </div>
                <div class="space-y-4">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border px-4 py-2 text-left">Título</th>
                                <th class="border px-4 py-2 text-left">Rol</th>
                                <th class="border px-4 py-2 text-left">Fecha Inicio</th>
                                <th class="border px-4 py-2 text-left">Fecha Fin</th>
                                <th class="border px-4 py-2 text-left">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (proyectos != null && proyectos.Any())
                            {
                                @foreach (var proyecto in proyectos)
                                {
                                    <tr>
                                        <td class="border px-4 py-2">@proyecto.Titulo</td>
                                        <td class="border px-4 py-2">@proyecto.RolEnProyecto</td>
                                        <td class="border px-4 py-2">@proyecto.FechaInicio.ToString("yyyy-MM-dd")</td>
                                        <td class="border px-4 py-2">@proyecto.FechaFin.ToString("yyyy-MM-dd")</td>
                                        <td class="border px-4 py-2 space-x-2">
                                            <button class="text-blue-600 hover:underline" @onclick="() => EditarProyecto(proyecto)">Editar</button>
                                            <button class="text-red-600 hover:underline" @onclick="() => EliminarProyecto(proyecto.Id)">Eliminar</button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="5" class="border px-4 py-2 text-center text-gray-400">No hay proyectos registrados.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    @if (mostrarFormulario)
    {
        <div class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-medium mb-4">@(editando ? "Editar Proyecto" : "Registrar Proyecto")</h3>
                <div class="space-y-2">
                    <input class="w-full border rounded px-3 py-2" placeholder="Título" @bind="proyectoForm.Titulo" />
                    <input class="w-full border rounded px-3 py-2" placeholder="Rol en Proyecto" @bind="proyectoForm.RolEnProyecto" />
                    <label class="block text-sm">Fecha Inicio</label>
                    <input type="date" class="w-full border rounded px-3 py-2" @bind="fechaInicioForm" />
                    <label class="block text-sm">Fecha Fin</label>
                    <input type="date" class="w-full border rounded px-3 py-2" @bind="fechaFinForm" />
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button class="px-4 py-2 rounded bg-gray-200" @onclick="()=>mostrarFormulario=false">Cancelar</button>
                    <button class="px-4 py-2 rounded bg-blue-600 text-white" @onclick="GuardarProyecto">Guardar</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<MyCleanApp.Client.Services.ProyectoInvestigacionDto>? proyectos;
    private bool isLoading = true;
    private string? error;
    private int docenteId = 0;
    private bool mostrarFormulario = false;
    private bool editando = false;
    private MyCleanApp.Client.Services.ProyectoInvestigacionDto proyectoForm = new();
    private DateTime fechaInicioForm = DateTime.Today;
    private DateTime fechaFinForm = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await CargarProyectos();
    }

    private async Task CargarProyectos()
    {
        try
        {
            isLoading = true;
            error = null;
            var loginResponse = await LocalStorageService.ObtenerObjetoAsync<LoginResponse>("loginResponse");
            if (loginResponse?.usuario == null)
            {
                error = "No se pudo obtener el usuario autenticado.";
                isLoading = false;
                return;
            }
            var docentes = await TeacherService.GetAllTeachersAsync();
            var docente = docentes?.FirstOrDefault(d => d.UsuarioId == loginResponse.usuario.Id);
            if (docente == null)
            {
                error = "No se encontró el perfil de docente para este usuario.";
                isLoading = false;
                return;
            }
            docenteId = docente.Id;
            var allProyectos = await ResearchProjectService.GetAllProjectsAsync();
            proyectos = allProyectos?.Where(p => p.DocenteId == docenteId).ToList();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        isLoading = false;
    }

    private void MostrarFormularioNuevo()
    {
        proyectoForm = new MyCleanApp.Client.Services.ProyectoInvestigacionDto();
        fechaInicioForm = DateTime.Today;
        fechaFinForm = DateTime.Today;
        editando = false;
        mostrarFormulario = true;
    }

    private void EditarProyecto(MyCleanApp.Client.Services.ProyectoInvestigacionDto proyecto)
    {
        proyectoForm = new MyCleanApp.Client.Services.ProyectoInvestigacionDto
        {
            Id = proyecto.Id,
            Titulo = proyecto.Titulo,
            RolEnProyecto = proyecto.RolEnProyecto,
            FechaInicio = proyecto.FechaInicio,
            FechaFin = proyecto.FechaFin,
            DocenteId = proyecto.DocenteId
        };
        fechaInicioForm = proyecto.FechaInicio;
        fechaFinForm = proyecto.FechaFin;
        editando = true;
        mostrarFormulario = true;
    }

    private async Task GuardarProyecto()
    {
        isLoading = true;
        error = null;
        try
        {
            proyectoForm.DocenteId = docenteId;
            proyectoForm.FechaInicio = fechaInicioForm;
            proyectoForm.FechaFin = fechaFinForm;
            if (editando && proyectoForm.Id > 0)
            {
                await ResearchProjectService.UpdateProjectAsync(proyectoForm.Id, proyectoForm);
            }
            else
            {
                await ResearchProjectService.CreateProjectAsync(proyectoForm);
            }
            mostrarFormulario = false;
            await CargarProyectos();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        isLoading = false;
    }

    private async Task EliminarProyecto(int id)
    {
        isLoading = true;
        error = null;
        try
        {
            await ResearchProjectService.DeleteProjectAsync(id);
            await CargarProyectos();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        isLoading = false;
    }
}
